# 快速开始指南

## 前置准备

### 1. 准备 WebDAV 服务

推荐的 WebDAV 服务提供商：
- **TeraCloud** (日本): 免费 10GB, 速度快
- **坚果云**: 免费 1GB/月流量
- **NextCloud**: 自建方案

### 2. 准备 Hugging Face

1. 注册 Hugging Face 账号: https://huggingface.co
2. 创建 Access Token:
   - 访问 Settings → Access Tokens
   - 创建新 Token (需要 write 权限)
   - 保存好 Token (格式: `hf_xxxxxxxxxxxx`)

### 3. 准备 GitHub

1. Fork 本仓库
2. 启用 GitHub Actions
3. 等待自动构建完成

## 部署方式

### 方式一: 部署到 Hugging Face Spaces (推荐)

#### 步骤 1: 创建 Space

1. 访问 https://huggingface.co/new-space
2. 填写信息:
   - **Space name**: 自定义名称
   - **License**: MIT
   - **Select the Space SDK**: Docker
   - **Space hardware**: CPU basic (免费)

#### 步骤 2: 配置环境变量

在 Space Settings → Variables and secrets 中添加:

```
WEBDAV_URL=https://your-webdav-server.com/dav
WEBDAV_USERNAME=your_username
WEBDAV_PASSWORD=your_password
WEBDAV_BACKUP_PATH=sys_backup
SYNC_INTERVAL=3600
HF_TOKEN=hf_your_token_here
HF_DATASET_REPO=storage-data
```

#### 步骤 3: 上传 Dockerfile

创建文件 `Dockerfile`:

```dockerfile
FROM ghcr.io/YOUR_GITHUB_USERNAME/clddat:latest
```

> 注意: 将 `YOUR_GITHUB_USERNAME` 替换为你的 GitHub 用户名

#### 步骤 4: 启动 Space

提交文件后，Space 会自动启动。首次启动需要 2-3 分钟。

#### 步骤 5: 访问服务

访问你的 Space URL，例如:
```
https://YOUR_USERNAME-YOUR_SPACE_NAME.hf.space
```

### 方式二: 本地部署

#### 使用自动化脚本

```bash
# 克隆仓库
git clone https://github.com/YOUR_USERNAME/clddat.git
cd clddat

# 运行部署脚本
chmod +x deploy.sh
./deploy.sh
```

按提示输入配置信息即可。

#### 手动部署

```bash
# 1. 创建配置文件
cp .env.example .env
# 编辑 .env 填入你的配置

# 2. 构建镜像
docker build -t clddat:latest .

# 3. 启动容器
docker run -d \
  --name clddat \
  -p 7860:7860 \
  --env-file .env \
  --restart unless-stopped \
  clddat:latest

# 4. 查看日志
docker logs -f clddat
```

## 首次使用

### 1. 登录系统

访问服务地址后，首次启动会显示管理员账号和密码，类似:

```
Admin Email: admin@cloudreve.org
Admin Password: xxxxxxxx
```

**重要**: 立即登录并修改密码！

### 2. 修改密码

1. 登录后点击右上角头像
2. 选择 "个人设置"
3. 修改密码

### 3. 验证存储配置

1. 上传一个测试文件
2. 检查文件是否出现在你的 Datasets 仓库中
3. 等待 1 小时后，检查 WebDAV 是否有备份文件

## 测试大文件上传

### 创建测试文件

```bash
# 创建 1GB 测试文件
dd if=/dev/zero of=test_1gb.bin bs=1M count=1024

# 或创建 5GB 测试文件
dd if=/dev/zero of=test_5gb.bin bs=1M count=5120
```

### 上传测试

1. 通过 Web 界面上传
2. 监控上传进度
3. 验证文件在 Datasets 中

## 常见问题排查

### 问题 1: 服务无法启动

**检查日志**:
```bash
# Docker 部署
docker logs clddat

# Hugging Face Spaces
查看 Spaces 的 Logs 标签页
```

**常见原因**:
- 环境变量未设置
- WebDAV 连接失败
- HF Token 权限不足

### 问题 2: 备份失败

**检查备份日志**:
```bash
docker exec clddat cat /tmp/backup.log
```

**解决方案**:
1. 验证 WebDAV 凭据
2. 检查 WebDAV 服务器状态
3. 确认网络连接

### 问题 3: 文件上传失败

**检查存储日志**:
```bash
docker exec clddat cat /tmp/cloudreve.log
```

**解决方案**:
1. 验证 HF Token 权限
2. 检查 Datasets 仓库是否存在
3. 确认网络连接

### 问题 4: 磁盘空间不足

**清理临时文件**:
```bash
docker exec clddat sh -c "du -sh /tmp/cache/*"
docker exec clddat sh -c "rm -rf /tmp/cache/*"
```

### 问题 5: 容器重启后数据丢失

**这是正常的！** 配置数据会自动从 WebDAV 恢复：

1. 容器启动时会自动下载最新备份
2. 用户文件存储在 Datasets，不会丢失
3. 如果备份失败，检查 WebDAV 连接

## 高级配置

### 调整备份频率

修改环境变量 `SYNC_INTERVAL`:
```bash
# 30 分钟备份一次
SYNC_INTERVAL=1800

# 2 小时备份一次
SYNC_INTERVAL=7200
```

### 增加最大文件大小

修改 `storage_policy.py` 中的:
```python
'max_size': '10737418240',  # 改为更大的值
```

### 自定义备份保留数量

修改 `backup_manager.py` 中的:
```python
self.max_backups = 5  # 改为需要的数量
```

### 配置 CORS (跨域访问)

在 `startup.sh` 中修改:
```ini
[CORS]
AllowOrigins = your-domain.com
AllowMethods = GET,POST,PUT,DELETE,OPTIONS
```

## 监控和维护

### 查看运行状态

```bash
# 查看容器状态
docker ps | grep clddat

# 查看资源使用
docker stats clddat

# 查看进程
docker exec clddat ps aux
```

### 手动触发备份

```bash
docker exec clddat python3 -c "from backup_manager import BackupManager; BackupManager().create_backup()"
```

### 手动恢复备份

```bash
docker exec clddat python3 -c "from backup_manager import BackupManager; BackupManager().restore_backup()"
```

### 查看备份列表

登录 WebDAV 服务器，查看 `sys_backup` 目录。

## 性能优化建议

### 1. 网络优化

- 选择地理位置近的 WebDAV 服务器
- 使用 CDN 加速 Datasets 访问

### 2. 存储优化

- 定期清理不需要的文件
- 使用压缩格式存储文件
- 避免大量小文件

### 3. 资源优化

如果在 Hugging Face Spaces:
- 考虑升级到付费硬件
- 使用 Persistent Storage 功能

## 安全建议

1. **立即修改默认密码**
2. **启用两步验证**
3. **定期更新 Token**
4. **监控异常访问**
5. **定期备份重要数据**

## 获取帮助

遇到问题？

1. 查看 [PROJECT_STRUCTURE.md](PROJECT_STRUCTURE.md) 了解架构
2. 查看 [README.md](README.md) 查看详细文档
3. 提交 GitHub Issue
4. 查看 Cloudreve 官方文档: https://docs.cloudreve.org

## 下一步

- 📚 阅读 [完整文档](README.md)
- 🏗️ 了解 [项目架构](PROJECT_STRUCTURE.md)
- ⚙️ 自定义配置
- 🔒 加强安全设置
- 📊 设置监控告警

祝使用愉快！ 🎉
