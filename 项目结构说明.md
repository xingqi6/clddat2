# 项目结构说明

```
clddat/
├── .github/
│   └── workflows/
│       └── docker-build.yml       # GitHub Actions 自动构建配置
├── backup_manager.py              # WebDAV 备份管理器
├── dataset_storage.py             # Datasets 存储适配器
├── storage_policy.py              # 存储策略配置模块
├── startup.sh                     # 容器启动脚本
├── deploy.sh                      # 本地部署脚本
├── Dockerfile                     # Docker 镜像构建文件
├── requirements.txt               # Python 依赖
├── .dockerignore                  # Docker 忽略文件
├── .env.example                   # 环境变量模板
└── README.md                      # 项目文档
```

## 文件说明

### 核心文件

1. **backup_manager.py**
   - 负责配置数据的备份和恢复
   - 定期将配置文件、数据库备份到 WebDAV
   - 启动时自动恢复最新备份
   - 自动清理旧备份，保留最近 5 份

2. **dataset_storage.py**
   - Hugging Face Datasets 存储适配器
   - 将用户上传的文件存储到 Datasets
   - 提供文件上传、下载、删除、列表功能
   - 支持大文件分块上传

3. **storage_policy.py**
   - 配置 Cloudreve 的存储策略
   - 设置 Datasets 为默认存储
   - 配置大文件处理参数
   - 优化上传性能

4. **startup.sh**
   - 容器启动入口脚本
   - 初始化环境和配置
   - 启动所有服务进程
   - 进程监控和自动重启
   - 健康检查和日志管理

### 配置文件

5. **Dockerfile**
   - 完整的镜像构建配置
   - 安装所有依赖
   - 下载 Cloudreve 二进制文件
   - 配置健康检查

6. **requirements.txt**
   - Python 依赖列表
   - 包含 WebDAV、Hugging Face Hub 等库

7. **.env.example**
   - 环境变量模板
   - 包含所有必需的配置项

### 部署文件

8. **deploy.sh**
   - 本地一键部署脚本
   - 交互式配置收集
   - 自动构建和启动容器
   - 日志查看功能

9. **.github/workflows/docker-build.yml**
   - GitHub Actions 工作流
   - 自动构建 Docker 镜像
   - 推送到 GitHub Container Registry
   - 缓存优化

## 部署流程

### GitHub → GHCR → Hugging Face

```
┌──────────┐     ┌──────────┐     ┌──────────────┐
│  GitHub  │────▶│   GHCR   │────▶│ Hugging Face │
│   Repo   │     │  镜像仓库  │     │    Spaces    │
└──────────┘     └──────────┘     └──────────────┘
     │                                     │
     │ Push 代码                            │ 拉取镜像
     │                                     │
     ▼                                     ▼
 触发构建                                运行容器
```

### 数据流

```
用户上传文件
    │
    ▼
┌─────────────┐
│  Cloudreve  │
└─────────────┘
    │
    ├──▶ 配置数据 ──▶ WebDAV (定期备份)
    │
    └──▶ 用户文件 ──▶ Datasets (持久存储)
```

## 运行时架构

```
容器内进程:
├── startup.sh (PID 1)
│   ├── cloudreve (主进程)
│   ├── backup_manager.py (备份进程)
│   ├── storage_policy.py (配置进程)
│   └── monitor (监控进程)
│
存储映射:
├── /app/conf → WebDAV 备份
├── /app/cloudreve.db → WebDAV 备份
└── /app/uploads → Datasets 存储
```

## 数据备份策略

### 备份内容
- ✅ 配置文件 (conf.ini)
- ✅ 数据库 (cloudreve.db)
- ✅ 配置目录 (conf/)
- ✅ 缩略图 (uploads/.thumbs/)
- ❌ 用户文件 (存储在 Datasets，不需要备份)

### 备份时机
- 启动时恢复最新备份
- 运行时定期备份（默认 1 小时）
- 关闭时执行最后一次备份

### 备份保留
- 保留最近 5 份备份
- 超过 5 份自动删除最早的
- 备份文件格式: `backup_YYYYMMDD_HHMMSS.tar.gz`

## 错误处理

### 网络错误
- WebDAV 连接失败: 自动重试，不影响主服务
- Datasets 上传失败: 分块重试，支持断点续传
- 健康检查失败: 自动重启进程

### 存储错误
- 磁盘空间不足: 自动清理临时文件
- 文件描述符不足: ulimit 已设置为 65535
- 大文件超时: 超时时间设置为 1 小时

### 进程错误
- 进程崩溃: 自动监控和重启
- 服务无响应: 健康检查自动重启
- 备份失败: 记录日志，下次重试

## 性能优化

### 上传优化
- 分块上传: 5MB per chunk
- 并行传输: 3 个并行连接
- 自动重试: 失败自动重试 3 次
- 缓冲区: 1MB 缓冲区大小

### 资源限制
- 最大文件: 10GB per file
- 总存储: 100GB (可在 Datasets 调整)
- 最大工作线程: 50
- 并行传输: 10

## 监控和日志

### 日志文件
- Cloudreve: `/tmp/cloudreve.log`
- 备份管理器: `/tmp/backup.log`

### 监控指标
- 进程存活状态
- HTTP 健康检查
- 备份成功率
- 磁盘使用情况

## 安全建议

1. **环境变量**
   - 使用 Secrets 存储敏感信息
   - 不要在代码中硬编码密码

2. **网络安全**
   - 使用 HTTPS 访问 WebDAV
   - Datasets 仓库设置为私有

3. **访问控制**
   - 修改 Cloudreve 默认密码
   - 启用两步验证
   - 定期审计访问日志

4. **数据备份**
   - 定期验证备份完整性
   - 测试恢复流程
   - 异地备份重要数据
