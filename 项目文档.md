# Cloud Storage System

一个基于容器化部署的云存储系统，支持自动数据备份和恢复。

## 功能特性

- ✅ 自动备份配置数据到 WebDAV
- ✅ 重启后自动恢复数据
- ✅ 保留最近 5 份备份
- ✅ 使用 Hugging Face Datasets 作为文件存储
- ✅ 支持大文件上传
- ✅ 自动构建 Docker 镜像

## 部署指南

### 1. 配置环境变量

需要设置以下环境变量：

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| `WEBDAV_URL` | WebDAV 服务器地址 | `https://jike.teracloud.jp/dav` |
| `WEBDAV_USERNAME` | WebDAV 用户名 | `myuser` |
| `WEBDAV_PASSWORD` | WebDAV 密码 | `mypassword` |
| `WEBDAV_BACKUP_PATH` | 备份文件夹名称 | `sys_backup` |
| `SYNC_INTERVAL` | 备份间隔（秒） | `3600` |
| `HF_TOKEN` | Hugging Face Token | `hf_xxx` |
| `HF_DATASET_REPO` | Dataset 仓库名 | `storage-data` |

### 2. 部署到 Hugging Face Spaces

1. Fork 本仓库
2. 在 GitHub 仓库设置中启用 Actions
3. 推送代码触发自动构建
4. 创建 Hugging Face Space（Docker 类型）
5. 在 Space 设置中添加上述环境变量
6. 上传 `Dockerfile (Hugging Face)` 并修改其中的用户名

### 3. 本地开发

```bash
# 克隆仓库
git clone https://github.com/YOUR_USERNAME/clddat.git
cd clddat

# 构建镜像
docker build -t clddat:local .

# 运行容器
docker run -d \
  -p 7860:7860 \
  -e WEBDAV_URL="your_webdav_url" \
  -e WEBDAV_USERNAME="your_username" \
  -e WEBDAV_PASSWORD="your_password" \
  -e WEBDAV_BACKUP_PATH="sys_backup" \
  -e SYNC_INTERVAL="3600" \
  -e HF_TOKEN="your_hf_token" \
  -e HF_DATASET_REPO="storage-data" \
  clddat:local
```

## 架构说明

### 数据存储策略

- **配置数据**：通过 WebDAV 定期备份到远程服务器
  - 数据库文件 (`cloudreve.db`)
  - 配置文件 (`conf.ini`)
  - 配置目录 (`conf/`)
  - 缩略图缓存 (`uploads/.thumbs/`)

- **用户文件**：直接存储到 Hugging Face Datasets
  - 不占用容器存储空间
  - 支持大文件上传
  - 持久化存储

### 备份机制

1. 启动时自动从 WebDAV 恢复最新备份
2. 运行期间定期创建备份（默认 1 小时）
3. 自动清理旧备份，保留最近 5 份
4. 备份文件采用 tar.gz 压缩格式

### 容错处理

- 进程自动监控和重启
- 网络错误自动重试
- 备份失败不影响主服务
- 健康检查确保服务可用

## 常见问题

### Q: 首次启动需要多久？
A: 首次启动约 2-3 分钟，包括下载依赖和初始化数据库。

### Q: 备份失败怎么办？
A: 备份失败不影响主服务运行，系统会在下个周期自动重试。

### Q: 如何修改备份频率？
A: 修改 `SYNC_INTERVAL` 环境变量，单位为秒。

### Q: 支持多大的文件上传？
A: 理论上无限制，文件存储在 Datasets 中，不占用容器空间。

### Q: WebDAV 服务器推荐？
A: 推荐使用 TeraCloud、坚果云、或自建 NextCloud。

## 注意事项

⚠️ **重要提示**

1. 确保 WebDAV 账号有足够的存储空间
2. 定期检查备份是否正常
3. 不要删除 Datasets 仓库中的文件
4. 建议使用私有的 Dataset 仓库
5. 妥善保管 HF_TOKEN，不要泄露

## 许可证

MIT License

## 贡献

欢迎提交 Issue 和 Pull Request！
